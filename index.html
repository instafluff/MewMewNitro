<html>
  <head>
    <title>Mew Mew Nitro</title>
    <link href="https://fonts.googleapis.com/css?family=Bubblegum+Sans" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/pinkfluffyunicorn@1.0.1/dist/pinkfluffyunicorn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinkfluffyunicorn@1.0.1/dist/eventemitter.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pinkfluffyunicorn@1.0.1/dist/keyboard.min.js"></script>
  </head>
  <body>
    <div id="unicorn-display"></div>
    <script>
        window.WebFontConfig = {
            google: {
                families: [ "Pacifico" ]
            },
            active() {
                CreateGame();
            },
        };

        /* eslint-disable */
        // include the web-font loader script
        (function() {
            const wf = document.createElement('script');
            wf.src = `${document.location.protocol === 'https:' ? 'https' : 'http'
            }://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`;
            wf.type = 'text/javascript';
            wf.async = 'true';
            const s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(wf, s);
        }());
        /* eslint-enabled */

        var counter = 0;
        var levelTime = 0;
		var isStarted = false;
		var isFinished = false;

        var player = {
            prevX: 0,
            scrollX: 0,
            isOnGround: false,
            touches: {},
            object: null,
            power: 0,
            boost: false
        };

        var ui = {
            powerBar: null
        };

        var gameObjects = [];
        function getRandomInt( number ) {
            return Math.floor( number * Math.random() );
        }

        function msToTime( s ) {
            // Pad to 2 or 3 digits, default is 2
            function pad(n, z) {
                z = z || 2;
                return ('00' + n).slice(-z);
            }

            var ms = s % 1000;
            s = ( s - ms ) / 1000;
            var secs = s % 60;
            s = ( s - secs ) / 60;
            var mins = s % 60;

            return pad( mins ) + ':' + pad( secs ) + '.' + pad( Math.floor( ms ), 3 );
        }

        function Init() {
			const worldSize = 2000;
            PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.NEAREST;
            // keyboard.on( "keydown", key => console.log( key ) );

            Unicorn.Load({
                "cat": "web/TurboCatYellow.png",
                "bar": "web/bar.png",
				"giftbox": "web/giftbox.png",
            });

            player.object = Unicorn.AddObject( "TurboCat", {
                type: "circle",
                x: 64, y: 64,
                radius: 32,
            	scale: { x: 2, y: 2 },
                sprite: "cat",
                // friction: 0.01,
                // onHover: function() {
                //   this.alpha = 0.5;
                // },
                // onLeave: function() {
                //   this.alpha = 1;
                // }
                onEnter: ( label, body ) => {
                    player.touches[ body.id ] = true;
                    player.isOnGround = ( Object.keys( player.touches ).some( x => !!player.touches[ x ] ) );
                    // console.log( "ground:", player.isOnGround );
                },
                onExit: ( label, body ) => {
                    delete player.touches[ body.id ];
                    player.isOnGround = ( Object.keys( player.touches ).some( x => !!player.touches[ x ] ) );
                    // console.log( "ground:", player.isOnGround );
                }
              });

            gameObjects = Unicorn.AddObject( {
            	"box1": {
                    type: "rectangle",
                    x: 1280, y: 720,
                    width: 128, height: 128,
					color: "#e76f51",
            		// angle: Math.PI / 4,
                    // friction: 0.01,
                    // onHover: function() {
                    //   this.alpha = 0.5;
                    // },
                    // onLeave: function() {
                    //   this.alpha = 1;
                    // }
            		isStatic: true,
              	},
                "box2": {
                  type: "rectangle",
                  x: 1600, y: 720,
                  width: 256, height: 256,
				  color: "#e76f51",
            		// angle: Math.PI / 4,
                  // friction: 0.01,
                  // onHover: function() {
                  //   this.alpha = 0.5;
                  // },
                  // onLeave: function() {
                  //   this.alpha = 1;
                  // }
            		isStatic: true,
                },
                "box3": {
                  type: "rectangle",
                  x: 2400, y: 720,
                  width: 512, height: 512,
				  color: "#e76f51",
            		// angle: Math.PI / 4,
                  // friction: 0.01,
                  // onHover: function() {
                  //   this.alpha = 0.5;
                  // },
                  // onLeave: function() {
                  //   this.alpha = 1;
                  // }
            		isStatic: true,
                },
            });

            // Rotate ramps
            gameObjects.forEach( o => {
            	Matter.Body.rotate( o, Math.PI / 4 );
            });

            console.log( gameObjects[ 0 ] );

			ui.title = Unicorn.AddText( "title", " Mew Mew Nitro ", 1280 / 2, 720 / 2, {
                fontFamily: 'Pacifico',
                fontSize: 128,
                fontWeight: 'bold',
                fill: "#e9c46a"
            });
			ui.title.anchor.set( 0.5 );
			ui.title.visible = true;
			ui.finishText = Unicorn.AddText( "finishText", " You Win! ", 1280 / 2, 720 / 3, {
                fontFamily: 'Pacifico',
                fontSize: 128,
                fontWeight: 'bold',
                fill: "#e9c46a"
            });
			ui.finishText.anchor.set( 0.5 );
			ui.finishText.visible = false;
			ui.finishTime = Unicorn.AddText( "finishTime", "Finish Time: 00:11.285", 1280 / 2, 720 / 2 + 30, {
                fontFamily: 'Pacifico',
                fontSize: 64,
                fontWeight: 'bold',
                fill: "#ffffff"
            });
			ui.finishTime.anchor.set( 0.5 );
			ui.finishTime.visible = false;
			ui.newRecord = Unicorn.AddText( "newRecord", "Mew Record!", 1280 / 2, 720 / 2 + 120, {
                fontFamily: 'Pacifico',
                fontSize: 64,
                fontWeight: 'bold',
                fill: "#e76f51"
            });
			ui.newRecord.anchor.set( 0.5 );
			ui.newRecord.visible = false;

            ui.timeText = Unicorn.AddText( "timeText", "Time", 200, 40, {
                fontFamily: 'Pacifico',
                fontSize: 52,
                fontWeight: 'bold',
                fill: "#ffffff"
            });
            ui.timeText.anchor.set( 0.5 );
            ui.timer = Unicorn.AddText( "levelTimer", "00:00.000", 100, 60, {
                fontFamily: 'Pacifico',
                fontSize: 52,
                fontWeight: 'bold',
                fill: "#ffffff"
            });
            ui.powerText = Unicorn.AddText( "powerBarText", "Paw Hotness", 1280 / 2, 40, {
                fontFamily: 'Pacifico',
                fontSize: 52,
                fontWeight: 'bold',
                fill: "#ffffff",
            });
            ui.powerText.anchor.set( 0.5 );
            ui.powerBarBG = Unicorn.AddOverlay( "powerBarBG", "bar", 520, 90, {
                scale: { x: 60, y: 10 },
            });
            ui.powerBarBG.tint = 0x000000;
			ui.powerBarBG.alpha = 0.5;
            ui.powerBar = Unicorn.AddOverlay( "powerBar", "bar", 520, 90, {
                scale: { x: 0, y: 10 },
            });
            ui.powerBar.tint = 0xe5989b;

            Unicorn.AddObject( "startBox", {
                type: "rectangle",
                x: 64, y: 300,
                width: 128, height: 20,
				color: "#e76f51",
                // sprite: "unicorn",
                // bounce: 3,
                isStatic: true
            } );
            Unicorn.AddDetector( "goal", {
                type: "rectangle",
                x: worldSize - 100, y: 720 - 60,
                width: 256, height: 256,
				sprite: "giftbox",
            }, ( label, body ) => {
                console.log( "Enter:", label, body );
				isFinished = true;
            }, ( label, body ) => {
                console.log( "Exit:", label, body );
            } );

            //
            // Unicorn.AddObject( "ball2", {
            //   type: "circle",
            //   x: 256, y: 64,
            //   radius: 64,
            //   // sprite: "ball",
            //   friction: 0.02
            // } );
            // Unicorn.ConnectObjects( "ball1", "ball2", {
            //   length: 192,
            //   damping: 0.5,
            //   stiffness: 0.2
            // } );
            // Unicorn.ConnectObjects( "", "ball2", {
            //   damping: 0.5,
            //   stiffness: 0.2
            // }, { x: 300, y: 0 } );

            // Unicorn.AddTimer( "boom", 5000, () => {
            //   Unicorn.SetVelocity( "ball1", 50, -10 );
            //   Unicorn.ResetTimer( "boom", 2000 );
            // } )


            // Set Walls
            Matter.World.add( physics.world, [ Matter.Bodies.rectangle( worldSize / 2, -50 - 500, worldSize * 2, 100, { isStatic: true } ) ] );
            // Matter.World.add( physics.world, [ Matter.Bodies.rectangle( worldSize / 2, opts.height + 50, worldSize * 2, 100, { isStatic: true } ) ] );
            // Matter.World.add( physics.world, [ Matter.Bodies.rectangle( -50, opts.height * 2 / 2, 100, opts.height * 2 * 2, { isStatic: true } ) ] );
            // Matter.World.add( physics.world, [ Matter.Bodies.rectangle( worldSize + 50, opts.height * 2 / 2, 100, opts.height * 2 * 2, { isStatic: true } ) ] );
			Unicorn.AddObject( "ground", {
	          type: "rectangle",
	          x: worldSize / 2, y: opts.height + 40,
	          width: worldSize * 2, height: 100,
			  color: "#f4a261",
	          // sprite: "unicorn",
	          // bounce: 3,
	          isStatic: true
	        } );
			Unicorn.AddObject( "wallLeft", {
	          type: "rectangle",
	          x: -50, y: opts.height * 2 / 2,
	          width: 100, height: opts.height * 2 * 2,
			  color: "#2a9d8f",
	          // sprite: "unicorn",
	          // bounce: 3,
	          isStatic: true
	        } );
			Unicorn.AddObject( "wallRight", {
	          type: "rectangle",
	          x: worldSize + 50, y: opts.height * 2 / 2,
	          width: 100, height: opts.height * 2 * 2,
			  color: "#264653",
	          // sprite: "unicorn",
	          // bounce: 3,
	          isStatic: true
	        } );

            Matter.Events.on( physics, "beforeUpdate", () => {
            	// console.log( "moving all the things!", player.object.position.x );
            	// const xMove = 1280 / 2 - player.object.position.x;
            	// console.log( xMove );
            	// physics.world.bodies.forEach( obj => {
            	// 	if( obj.label !== "Rectangle Body" ) {
            	// 		console.log( obj );
            	// 		obj.position.x += xMove;
            	// 		// if( obj.label !== "TurboCat" ) {
            	// 		// 	obj.inertia = 0;
            	// 		// 	obj.inverseInertia = 0;
            	// 		// }
            	// 	}
            	// });
            });
        }

        function Update( timestamp, timeDiffInMs ) {
            // Add Update Loop
            // console.log( timestamp, timeDiffInMs );
			if( isFinished ) {

			}
            else if( isStarted ) {
				levelTime += timeDiffInMs;
	            ui.timer.text = msToTime( levelTime );

	            if( player.isOnGround && ( kbState[ "w" ] || kbState[ " " ] || kbState[ "ArrowUp" ] ) ) {
	            	// Unicorn.SetVelocity( "TurboCat", player.object.velocity.x, player.object.velocity.y - 2 );
	                if( player.power < 100 ) {
	                    player.power += 10;
	            		player.object.force.y = -0.1;
	                }
	            	console.log( physics.world );
	            }
	            if( player.isOnGround && ( kbState[ "a" ] || kbState[ "ArrowLeft" ] ) ) {
	                // Check power
	                if( player.power < 100 ) {
	            		player.object.force.x = -0.01;
	                }
	            }
	            if( player.isOnGround && ( kbState[ "d" ] || kbState[ "ArrowRight" ] ) ) {
	                // Check power
	                if( player.power < 100 ) {
	            		player.object.force.x = 0.01;
	                }
	            }
	            if( kbState[ "a" ] || kbState[ "d" ] || kbState[ "ArrowLeft" ] || kbState[ "ArrowRight" ] ) {
	                if( player.power < 100 ) {
	                    player.power += 10 * timeDiffInMs / 1000;
	                }
	            }
	            else {
	                // Cooldown
	                if( player.power > 0 ) {
	                    player.power -= 20 * timeDiffInMs / 1000;
	                }
	                else {
	                    player.power = 0;
	                }
	            }
	            ui.powerBar.scale.x = Math.max( 0, Math.min( 100, player.power ) ) / 100 * 40;
			}
			else {
				isStarted = kbState[ "ArrowLeft" ] || kbState[ "ArrowRight" ] || kbState[ "ArrowUp" ] ||
					kbState[ "a" ] || kbState[ "d" ] || kbState[ "w" ] ||
					kbState[ " " ];
			}

			const xDiff = player.object.position.x - player.prevX;
			player.prevX = player.object.position.x;
			player.scrollX += xDiff;
			// console.log( player.scrollX );
			Object.keys( objectSprite ).forEach( x => {
				// if( x.label !== "TurboCat" ) {
					objectSprite[ x ].x -= player.scrollX - 1280 / 2;
				// }
			});
        }

        function OnChatCommand( user, command, message, flags, extra ) {
            // Handle Chat Commands
        }

        function OnChatMessage( user, message, flags, self, extra ) {
            // Handle Chat Messages
        }

        function CreateGame() {
            Unicorn.Create( "unicorn-display", {
                width: 1280,
                height: 720,
                background: 0xe264653,// "transparent",
                // background: "transparent",
                init: Init,
                update: Update,
                channel: "Instafluff",
                onCommand: OnChatCommand,
                onChat: OnChatMessage,
                screenWalls: false // Default: true
                // gravity: { x: 0, y: 0.5 } // Default: { x: 0, y: 1 }
            });
        };
    </script>
  </body>
</html>
